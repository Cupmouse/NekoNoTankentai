<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nekonium Block Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css"
          integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/font-awesome.min.css">
    <link rel="stylesheet" href="./css/main.css">
    <script type="application/javascript" src="js/Chart.min.js"></script>
    <script type="application/javascript" src="js/bignumber.min.js"></script>
</head>
<body>
<header>
    <div class="pure-g">
        <div class="pure-u-3-4">
            <a id="title" href="#" onclick="loadViewHome()">üö©„Å≠„Åì„ÅÆÊé¢Ê§úÈöä</a>

            <div id="menu" class="pure-menu pure-menu-horizontal">
            <nav>
                <ul class="pure-menu-list">
                    <li class="pure-menu-item">
                        <a href="#" onclick="loadViewBlock('170317')" class="pure-menu-link"><i class="fa fa-th-large" aria-hidden="true"></i> Blocks</a>
                    </li>
                    <li class="pure-menu-item">
                        <a href="#" onclick="loadViewTransactionList()" class="pure-menu-link"><i class="fa fa-exchange" aria-hidden="true"></i> Transactions</a>
                    </li>
                    <li class="pure-menu-item pure-menu-disabled">
                        <i class="fa fa-bar-chart" aria-hidden="true"></i> Statistics
                    </li>
                </ul>
            </nav>
            </div>
        </div>
        <div class="pure-u-1-4">
            <div id="mini-statistics" class="pure-g text-selectable">
                <div class="pure-u-1-3">
                    # 1000000
                </div>
                <div class="pure-u-1-3">
                    Diff 150T
                </div>
                <div class="pure-u-1-3">
                    ¬• 1000
                </div>
            </div>
        </div>
        <div class="pure-u-1">
            <form id="search-form" class="pure-form">
                <input type="text" id="search-box" class="pure-input-1" placeholder="Search">
            </form>
            <div id="search-suggestions">
                <ul id="search-suggestion-list">
                </ul>
            </div>
        </div>
    </div>
</header>
<div id="contents-wrapper">
    <!-- Loading screen appears only on view loading -->
    <div id="loading">
        LOADING...
    </div>
    <!-- Inserts an contents in this div tag using Ajax -->
    <div id="contents">


    </div>
</div>

<script type="application/javascript">
    let div_contents = document.getElementById('contents');
    let search_box = document.getElementById('search-box');
    let search_suggestions = document.getElementById('search-suggestion-list');

    const REGEX_ADDRESS = /^0x[0-9a-fA-F]{40}$/;
    const REGEX_TRANSACTION = /^0x[0-9a-fA-F]{64}$/;

    class RequestService {
        constructor() {
            this.connected = false;
            this.connecting = false;
            this.id = 0;
        }

        connectIfNot() {
            if (this.connected || this.connecting) {
                // Connection is already established or trying to
                return;
            }

            /* Connect to the server */
            this.connecting = true;

            this.callbacks = new Map(); // Create map for storing a nonce and callbacks pair
            this.websocket = new WebSocket('ws://localhost:8080/request');  // Connect to the request websocket server

            let self = this;

            this.websocket.onopen = function () {
                self.connected = true;
                self.connecting = false;
                console.debug("CONNECTION OPENED");
            };
            this.websocket.onclose = function () {
                self.connected = false;
                self.connecting = false;
                console.debug("CONNECTION CLOSED");
            };

            this.websocket.onmessage = function (event) {  // Set onmessage listener
                let response = JSON.parse(event.data); // Parsing from STRING to OBJECT, not otherwise
                let id = response['id'];

                let callback = self.callbacks.get(id);  // Get callback for the id

                callback(response['content']); // Call callback function

                self.callbacks.delete(id);  // Delete callback from the map
            };

            this.nonce = 0; // Initial nonce is 0
            this.id++;  // Increment connection id
        }

        connectAndRequest(demand, content, callback) {
            this.connectIfNot();

            let wrapped = { // Wrap content
                id: this.nonce,
                demand: demand,
                content: content
            };

            let message = JSON.stringify(wrapped);

            this.callbacks.set(this.nonce, callback);       // Store the callback for response
            this.nonce++;   // Inclement nonce for the next request

            if (this.connected) {
                /* A connection is already established, sending a request immediately */
                this.websocket.send(message);   // Send a request to the server
                console.debug("send#1");
            } else {
                /* Send message to server, retry if connection is not ready */
                let self = this;
                let storedId = this.id;

                let timerId = setInterval(function () {
                    if (self.id !== storedId) {
                        // Connection changed, maybe reestablished
                        clearInterval(timerId); // This function is no longer be called
                        console.debug("discarded#1");

                    } else if (self.connected) {
                        self.websocket.send(message);   // Send to request websocket server
                        clearInterval(timerId); // Stop calling this function
                        console.debug("send#2");

                    } else if (!self.connecting) {
                        // Connection is not established but not trying to
                        clearInterval(timerId); // Guess connection failed
                        console.debug("discarded#2");
                    }
                }, 100);
            }
        }
    }

    let requestService = new RequestService();

    let searchStateId = 0;
    let searchTimeoutId;

    // Registering search box input event
    search_box.addEventListener('input', function () {
        // Gets the inputted string from the search box
        let search_string = search_box.value;

        if (search_string.length === 0) {
            // If search word is empty string, going back to home
        }

        let stored_ssid = ++searchStateId;

        if (searchTimeoutId !== undefined) {
            // Cancel former search wait
            clearTimeout(searchTimeoutId);
        }

        // Wait for the user inputting to settle
        searchTimeoutId = setTimeout(function () {
            requestService.connectAndRequest('search', search_string, function (content) {
                if (searchStateId !== stored_ssid) {
                    // Another search was issued later, discard this
                    console.debug("s_discarded");
                    return;
                }

                let suggestionHTML = "";
                for (let i = 0; i < content.length; i++) {
                    let link_label;

                    switch (content[i][0]) {
                        case 'block_number':        link_label = "Block Number"; break;
                        case 'block_hash':          link_label =  "Block"; break;
                        case 'transaction_hash':    link_label =  "Transaction"; break;
                        case 'normal_address':      link_label =  "Address"; break;
                        case 'contract_address':    link_label =  "Contract Address"; break;
                    }

                    link_label += " " + content[i][1];

                    suggestionHTML += `<li>${link_label}</li>`;
                }

                search_suggestions.innerHTML = suggestionHTML;
            });
        }, 250);
    });

    document.getElementById('search-form').addEventListener('submit', function () {
        alert("is it");
        return false;
    });

//    loadViewHome();

    function isAddress(addr) {
        // TODO Upper case lower case error check

        return REGEX_ADDRESS.test(addr);
    }

    function isTransactionId(tx_id) {
        return REGEX_TRANSACTION.test(tx_id);
    }

    function loadViewHome() {
        loadingStart();

        div_contents.innerHTML =
`<div class="pure-u-1">
    <div id="latest_updates"></div>
</div>`;
        // TODO Registering events

        loadingEnd();
    }

    function loadViewAddress($address) {
        loadingStart();

        div_contents.innerHTML =
            `<div class="pure-u-1">
    <h1>Address ${address}</h1>
</div>`;

        loadingEnd();
    }

    const aboutTagList = ['hash', 'miner', 'difficulty', 'gas_used', 'gas_limit',
        'extra_data', 'nonce', 'sha3_uncles', 'size', 'internal_id'];
    const ONE_NUKO = new BigNumber(10).pow(18);

    function loadViewBlock($blockNumber) {
        let content = ['number', $blockNumber, 'all', 'all'];

        loadingStart();

        requestService.connectAndRequest('block', content, function (response) {
            if (response === false) {
                return;
            }

            let uncles_html = "";
            let transactions_html = "";

            let uncles = response['uncles'];
            for (let i in uncles) {
                uncles_html += `#${uncles[i]['number']}<br>`;
            }

            let transactions = response['transactions'];

            for (let i in transactions) {
                let txValue = new BigNumber(transactions[i]['value']).div(ONE_NUKO);

                transactions_html += `<div class="tx-list-element tx-sending">
                        <span class="tx-list-title">Sending ${txValue} NUKO</span><br>
                        ${transactions[i]['from']} <i class="fa fa-arrow-right" aria-hidden="true"></i> ${transactions[i]['to']}<br>
                        ${transactions[i]['hash']}
                    </div>`;
            }


            let about_html = "";

            for (let i in aboutTagList) {
                about_html += `<span class="mini-caption">${aboutTagList[i]}</span>
                            <span class="captioned-text">${response[aboutTagList[i]]}</span>`;
            }

            div_contents.innerHTML =
                `<div class="pure-g">
            <div id="blockview-left" class="pure-u-1-8">
                <div id="blockview-list">
                    <span class="blockview-list-element">1</span>
                    <span class="blockview-list-element">2</span>
                    <span class="blockview-list-element">3</span>
                    <span class="blockview-list-element">4</span>
                    <span class="blockview-list-element">5</span>
                    <span class="blockview-list-element">6</span>
                    <span class="blockview-list-element">7</span>
                    <span class="blockview-list-element">8</span>
                    <span class="blockview-list-element">9</span>
                    <span class="blockview-list-element">10</span>
                    <span class="blockview-list-element">11</span>
                </div>
            </div>
            <div class="pure-u-7-8">
                <div id="blockview-right">
                    <h1>Block #${response['number']}</h1>
                    <div >
                        <div class="block-time">
                            <canvas id="canvas-block-time-clock" class="block-time-clock" height="200px" width="200px"></canvas>
                        </div>
                        <div class="block-about">
                            ${about_html}
                        </div>
                    </div>
                    <div>
                        <h2>Citing ${response['uncles'].length} Uncle(s)</h2>

                        ${uncles_html}
                    </div>
                    <div>
                        <h2>${response['transactions'].length} Transaction(s)</h2>

                        ${transactions_html}
                    </div>
                </div>
            </div>
        </div>`;

            let cc = document.getElementById('canvas-block-time-clock').getContext('2d');
            drawClock(cc, response['timestamp']);

            loadingEnd();
        });
    }

    function loadingStart() {
        document.getElementById('loading').style.display = 'block';
    }
    function loadingEnd() {
        document.getElementById('loading').style.display = 'none';
    }

    function drawClock(context, unixEpoch) {
        let date = new Date(unixEpoch * 1000);
        let seconds = date.getUTCSeconds();
        let minutes = date.getUTCMinutes();
        let hours = date.getUTCHours() % 12;

        _drawClock(context, hours, minutes, seconds);
    }

    /**
     * Perform an drawing of current time to the context
     * @param context
     */
    function drawClockNow(context) {
        let date = new Date();
        let seconds = date.getUTCSeconds();
        let minutes = date.getUTCMinutes();
        let hours = date.getUTCHours() % 12;

        _drawClock(context, hours, minutes, seconds);
    }

    function _drawClock(context, hours, minutes, seconds) {
        let stheta = (seconds * 2 * Math.PI) / 60;
        let mtheta = ((minutes + seconds / 60) * 2 * Math.PI) / 60;
        let htheta = ((hours + minutes / 60 + seconds / (60 * 60)) * 2 * Math.PI) / 12;

        let ssin = Math.sin(stheta);
        let scos = Math.cos(stheta);
        let msin = Math.sin(mtheta);
        let mcos = Math.cos(mtheta);
        let hsin = Math.sin(htheta);
        let hcos = Math.cos(htheta);

        // „ÇØ„É™„Ç¢
        context.clearRect(0, 0, 200, 200);

        // Â§ñÊû†
        context.beginPath();
        context.lineWidth = 2;
        context.arc(100, 100, 98, 0, 2 * Math.PI);
        context.closePath();
        context.stroke();

        context.font = 'bold 20px sans-serif';
        context.textAlign = "center";
        context.textBaseline = "bottom";
        context.fillText('UTC', 100, 77);

        // ÁßíÈáù
        context.beginPath();
        context.lineWidth = 1;
        context.moveTo(100 - 15 * ssin, 100 + 15 * scos);
        context.lineTo(100 + 80 * ssin, 100 - 80 * scos);
        context.stroke();

        // Èï∑Èáù
        context.beginPath();
        context.lineWidth = 3;
        context.moveTo(100 - 5 * msin, 100 + 5 * mcos);
        context.lineTo(100 + 90 * msin, 100 - 90 * mcos);
        context.stroke();

        // Áü≠Èáù
        context.beginPath();
        context.lineWidth = 6;
        context.moveTo(100 - 5 * hsin, 100 + 5 * hcos);
        context.lineTo(100 + 60 * hsin, 100 - 60 * hcos);
        context.stroke();
    }


    loadingEnd();
</script>

<footer>
<div class="pure-g">
<div class="pure-u-1-1">
    2017 Made with ‚ù§ by Cupmouse <a href="https://twitter.com/Cupnmouse" target="_blank"><i style="color: #1da1f2" class="fa fa-twitter" aria-hidden="true"></i></a><br>
    <!-- Just kidding, who the hell loves code. Is it kind of a weird fetish? -->
</div>
</div>
</footer>
</body>
</html>