<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nekonium Block Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css"
          integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/font-awesome.min.css">
    <link rel="stylesheet" href="./css/main.css">
    <script type="application/javascript" src="js/Chart.min.js"></script>
    <script type="application/javascript" src="js/bignumber.min.js"></script>
</head>
<body>
<header>
    <div class="pure-g">
        <div class="pure-u-3-4">
            <a id="title" href="#" onclick="loadViewHome()">üö©„Å≠„Åì„ÅÆÊé¢Ê§úÈöä</a>

            <div id="menu" class="pure-menu pure-menu-horizontal">
                <nav>
                    <ul class="pure-menu-list">
                        <li class="pure-menu-item">
                            <a href="#" onclick="loadViewBlock('170317')" class="pure-menu-link"><i class="fa fa-th-large" aria-hidden="true"></i> Blocks</a>
                        </li>
                        <li class="pure-menu-item">
                            <a href="#" onclick="loadViewTransactionList()" class="pure-menu-link"><i class="fa fa-exchange" aria-hidden="true"></i> Transactions</a>
                        </li>
                        <li class="pure-menu-item pure-menu-disabled">
                            <i class="fa fa-bar-chart" aria-hidden="true"></i> Statistics
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="pure-u-1-4">
            <div id="mini-statistics" class="pure-g text-selectable">
                <div class="pure-u-1-3">
                    # 1000000
                </div>
                <div class="pure-u-1-3">
                    Diff 150T
                </div>
                <div class="pure-u-1-3">
                    ¬• 1000
                </div>
            </div>
        </div>
        <div class="pure-u-1">
            <form id="search-form" class="pure-form">
                <input type="text" id="search-box" class="pure-input-1" placeholder="Search">
            </form>
            <div id="search-suggestions">
                <ul id="search-suggestion-list">
                </ul>
            </div>
        </div>
    </div>
</header>
<div id="contents-wrapper">
    <!-- Inserts an contents in this div tag using Ajax -->
    <div id="contents">

    </div>

</div>
<script type="application/javascript">

    const div_contents = document.getElementById('contents');

    const BLOCKLIST_PAGINATION_LIMIT = 9;

    // Flow: new PaginationControl() -> addWrapper() -> setListener() ----> setPageNum() -> setLastPageNum() -> updateHTML()
    class PaginationControl {

        constructor(limit, initPageNum, initLastPageNum) {
            this.limit = limit;     // Limit of buttons which has page number written on shown

            this.pageNumber = initPageNum;
            this.lastPageNumber = initLastPageNum; // Number of the last page
            this.listener = null;
            this.wrapperDivs = [];  // Initialize an array
        }

        addWrapper(wrapperDiv) {
            this.wrapperDivs.push(wrapperDiv);  // Add new wrapper
            wrapperDiv.addEventListener('click', this._buttonClicked);  // Add click event listener to wrapper
        }

        setListener(listener) {
            this.listener = listener;
        }

        update(pageNumber, lastPageNumber) {
            this.pageNumber = pageNumber;   // Change page number to new one
            this.lastPageNumber = lastPageNumber;   // This one too

            // Update pagination HTML inside of all wrappers

            let pagHTML = this.getHTML();

            for (let i in this.wrapperDivs) {
                this.wrapperDivs[i].innerHTML = pagHTML;
            }
        }

        getHTML() {
            let htmlPag;

            if (this.pageNumber === 1) {
                htmlPag = '<button class="pure-button" disabled>&lt;&lt;</button><button class="pure-button" disabled>&lt;</button>';
            } else {
                htmlPag = '<button class="pure-button">&lt;&lt;</button><button class="pure-button">&lt;</button>';
            }

            // Calculates where page to start

            let pageStart;

            // Can selected page button be centered?
            if (this.lastPageNumber > this.limit) {
                if (this.pageNumber - (this.limit / 2) < 1) {
                    // Don't have enough space left side, start from 1
                    pageStart = 1;
                } else if (this.pageNumber + (this.limit / 2) > this.lastPageNumber) {
                    // Don't have enough space right side
                    pageStart = this.lastPageNumber - this.limit + 1;
                } else {
                    // Have space for both side
                    pageStart = this.pageNumber - Math.floor((this.limit / 2));
                }
            } else {
                // Can show all of page buttons
                pageStart = 1;
            }

            // Generate an button for each page
            let i = pageStart;

            for (; (i < pageStart + this.limit) && (i <= this.lastPageNumber); i++) {
                // Selected button will be shown differently
                if (i === this.pageNumber) {
                    htmlPag += '<button class="pure-button pagination-element-selected" disabled>' + i + '</button>';
                } else {
                    htmlPag += '<button class="pure-button">' + i + '</button>';
                }
            }

            if (i <= this.lastPageNumber) {
                // Add [...] button if there are more pages after
                htmlPag += '<button class="pure-button" disabled>...</button>';
            }

            if (this.pageNumber === this.lastPageNumber) {
                // Make both button disable
                htmlPag += '<button class="pure-button" disabled>&gt;</button><button class="pure-button" disabled>&gt;&gt;</button>';
            } else {
                htmlPag += '<button class="pure-button">&gt;</button><button class="pure-button">&gt;&gt;</button>';
            }

            return htmlPag;
        }

        _buttonClicked(event) {
            if (event.target.tagName !== 'BUTTON') {
                return;
            }

            switch (event.target.innerText) {
                case '<<':
                    this._callListener(1);  // Go all the way back to page 1
                    break;
                case '<' :
                    this._callListener(this.pageNumber - 1);  // Go back to the previous page
                    break;
                case '>>':
                    this._callListener(this.lastPageNumber); // Go to the last page TODO last page may change, this will not always direct to the 'real' last page
                    break;
                case '>':
                    this._callListener(this.pageNumber + 1);
                    break; // Go to the next page
                default:
                    // Assume all button's innnerText is not malformed, treat it as a target page number
                    this._callListener(parseInt(event.target.innerText, 10)); // Jump to the target page
                    break;
            }
        }

        _callListener(targetPageNumber) {
            this.listener(targetPageNumber);
        }
    }

    /**
     *
     * @param elemId
     * @param pagControl Populate HTML if set
     * @returns {string}
     */
    function genNewPagWrapperHTML(elemId, pagControl = undefined) {
        let cont = '';

        if (pagControl !== undefined) { // No initialize
            cont = pagControl.getHTML();
        }

        return '<div id="' + elemId + '" class="pure-u-1 pure-button-group pagination" role="group">' + cont + '</div>';
    }

    class ViewBlockList {

        constructor(pageNumber) {
            this.pageNumber = pageNumber;
        }

        open() {
            let data = [[{'number': '1500', 'hash': '0x?', 'miner': '0x?', 'internal_id': '1501', 'tx_count': 1, 'uncle_count': 0, 'forked': true}],
                10];

            // Generate table content
            let tableContent = this._genTableContent(data[0]);

            // Generate pagination
            let pag = new PaginationControl(BLOCKLIST_PAGINATION_LIMIT, this.pageNumber, data[1]);

            // Replace content
            div_contents.innerHTML = `<div class="pure-g">
            ${genNewPagWrapperHTML('blocklist-pagination-top', pag)}
            <div class="pure-u-1">
                <table id="blocklist-table" class="pure-table pure-table-striped">
                    <thead>
                    <tr><th>#</th><th>Hash</th><th>Miner</th><th>Tx#</th><th>Uncle#</th><th>Forked?</th><th>Id</th></tr>
                    </thead>
                    <tbody>
                    ${tableContent}
                    </tbody>
                </table>
            </div>
            ${genNewPagWrapperHTML('blocklist-pagination-bottom', pag)}
        </div>`;

            pag.addWrapper(document.getElementById('blocklist-pagination-top'));
            pag.addWrapper(document.getElementById('blocklist-pagination-bottom'));

            let self = this;
            pag.setListener(function (pageNumber) {
                self.changePageTo(pageNumber);
            });
        }

        changePageTo(pageNumber) {
            let tableDiv = document.getElementById('blocklist-table');

            // TODO ask for new block list data

            tableDiv.innerHTML = this._genTableContent();
        }

        _genTableContent(blocks) {
            let tableContent = '';

            for (let i in blocks) {
                let blockelm = blocks[i];
                let number = blockelm['number'];
                let hash = blockelm['hash'];
                let miner = blockelm['miner'];
                let internalId = blockelm['internal_id'];
                let txCount = blockelm['tx_count'];
                let uncleCount = blockelm['uncle_count'];
                let forked = blockelm['forked'] ? '<i class="fa fa-code-fork" aria-hidden="true"></i> Forked' : 'On-main';

                tableContent +=
                    `<tr>
                    <td><a href="/block/number/${number}">${number}</a></td>
                    <td><a href="/block/hash/${hash}">${hash}</a></td>
                    <td><a href="/address/${miner}">${miner}</a></td>
                    <td><a href="/block/id/${internalId}">${txCount}</a></td>
                    <td><a href="/block/id/${internalId}">${uncleCount}</a></td>
                    <td>${forked}</td>
                    <td><a href="/block/id/${internalId}">${internalId}</a></td>
                    </tr>`
            }

            return tableContent;
        }
    }

    let view = new ViewBlockList(9);
    view.open();

</script>
<footer>
    <div class="pure-g">
        <div class="pure-u-1-1">
            2017 Made with ‚ù§ by Cupmouse <a href="https://twitter.com/Cupnmouse" target="_blank"><i style="color: #1da1f2" class="fa fa-twitter" aria-hidden="true"></i></a><br>
            <!-- Just kidding, who the hell loves code. Is it kind of a weird fetish? -->
        </div>
    </div>
</footer>
</body>
</html>