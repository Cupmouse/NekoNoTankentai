<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nekonium Block Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css"
          integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/font-awesome.min.css">
    <link rel="stylesheet" href="./css/main.css">
    <script type="application/javascript" src="js/Chart.min.js"></script>
    <script type="application/javascript" src="js/bignumber.min.js"></script>
</head>
<body>
<header>
    <div class="pure-g">
        <div class="pure-u-3-4">
            <a id="title" href="#" onclick="loadViewHome()">üö©„Å≠„Åì„ÅÆÊé¢Ê§úÈöä</a>

            <div id="menu" class="pure-menu pure-menu-horizontal">
                <nav>
                    <ul class="pure-menu-list">
                        <li class="pure-menu-item">
                            <a href="#" onclick="loadViewBlock('170317')" class="pure-menu-link"><i class="fa fa-th-large" aria-hidden="true"></i> Blocks</a>
                        </li>
                        <li class="pure-menu-item">
                            <a href="#" onclick="loadViewTransactionList()" class="pure-menu-link"><i class="fa fa-exchange" aria-hidden="true"></i> Transactions</a>
                        </li>
                        <li class="pure-menu-item pure-menu-disabled">
                            <i class="fa fa-bar-chart" aria-hidden="true"></i> Statistics
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="pure-u-1-4">
            <div id="mini-statistics" class="pure-g text-selectable">
                <div class="pure-u-1-3">
                    # 1000000
                </div>
                <div class="pure-u-1-3">
                    Diff 150T
                </div>
                <div class="pure-u-1-3">
                    ¬• 1000
                </div>
            </div>
        </div>
        <div class="pure-u-1">
            <form id="search-form" class="pure-form">
                <input type="text" id="search-box" class="pure-input-1" placeholder="Search">
            </form>
            <div id="search-suggestions">
                <ul id="search-suggestion-list">
                </ul>
            </div>
        </div>
    </div>
</header>
<div id="contents-wrapper">
    <!-- Inserts an contents in this div tag using Ajax -->
    <div id="contents">
        <div class="pure-g">
            <div id="blockview-left" class="pure-u-1-4">
                <div id="blockview-list">
                    <div id="blockview-list-inner">

                    </div>
                </div>
            </div>
            <div class="pure-u-3-4">
                <div id="blockview-right">
                    <div>
                        <h1>Block #${response['number']}</h1>
                        <div class="block-time">
                            <canvas id="canvas-block-time-clock" class="block-time-clock" height="200px" width="200px"></canvas>
                        </div>
                        <div class="block-about">
                            <table class="pure-table pure-table-striped">
                                <tbody>
                                <tr><th>Hash</th><td>${response['hash']}</td></tr>
                                <tr><th>Mined by</th><td>${response['miner']}</td></tr>
                                <tr><th>Difficulty</th><td>${response['difficulty']}</td></tr>
                                <tr><th>Gas</th><td>${response['gas_used']}/${response['gas_limit']}</td></tr>
                                <tr><th>Nonce</th><td>${response['nonce']}</td></tr>
                                <tr><th>sha3 Uncles</th><td>${response['sha3_uncles']}</td></tr>
                                </tbody>
                            </table>
                            <span class="mini-caption">Hash</span>
                            <span class="captioned-text">${response['hash']}</span>
                            <span class="mini-caption">Mined by</span>
                            <span class="captioned-text">${response['miner']}</span>
                            <span class="mini-caption">Difficulty</span>
                            <span class="captioned-text">${response['difficulty']}</span>
                            <span class="mini-caption">Gas</span>
                            <span class="captioned-text">${response['gas_used']}/${response['gas_limit']}</span>
                            <span class="mini-caption">Nonce</span>
                            <span class="captioned-text">${response['nonce']}</span>
                            <span class="mini-caption">sha3 Uncles</span>
                            <span class="captioned-text">${response['sha3_uncles']}</span>
                        </div>
                    </div>
                    <div>
                        <h2>Citing ${response['uncles'].length} Uncle(s)</h2>

                    </div>
                    <div>
                        <h2>${response['transactions'].length} Transaction(s)</h2>

                        <div class="tx-list-element tx-sending">
                            <span class="tx-list-title">Sending ${txValue} NUKO</span><br>
                            ${transactions[i]['from']} <i class="fa fa-arrow-right" aria-hidden="true"></i> ${transactions[i]['to']}<br>
                            ${transactions[i]['hash']}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="application/javascript">
    const MAX_INIT_BLOCK_LIST_ELEMENTS_PER_SIDE = 100;  // This can't be small enough to fit the biggest screen in the world
    const BLOCK_LIST_ELEMENTS_LOAD_N = 20;  // Maximum of this number of block list elements are added each time when scroll change is performed

    let blocklistInner = document.getElementById('blockview-list-inner');
    let blocklist = document.getElementById('blockview-list');

    let latestBlockNumber = undefined; // Latest block number
    let blockListInitialized = false;
    let scrollCheckIntervalId;  // setInterval id of scrollCheck calling
    let scrollAction = false; // Not to do scroll change if events are issued while performing it
    let elementHeight = -1; // Height of one block list element
    let nextTopBlockNum;    // Next block number will be added to the block list on BEGINNING
    let nextBottomBlockNum; // Next block number will be added to the block list on END including a working block

    let wsBlockNumber = new WebSocket('ws://localhost:8080/block-number');

    wsBlockNumber.onmessage = function (event) {
        let beforeLatestBlockNumber = latestBlockNumber;
        latestBlockNumber = new BigNumber(event.data);

        if (beforeLatestBlockNumber === undefined) {   // If this was the first message
            /* Initialize block list */

//            fillBlockList(new BigNumber(500));

            fillBlockList(latestBlockNumber.sub(16));

            blockListInitialized = true;    // Block list successfully initialized, now scroll event will be performed
        } else {
            if (latestBlockNumber.comparedTo(beforeLatestBlockNumber) < 0) {
                /* Block chain reorganization happened (forking) */

                nextBottomBlockNum = latestBlockNumber.add(1);
                let i = nextBottomBlockNum;

                /* Removing list elements who got deleted from the blockchain */
                while (i.comparedTo(beforeLatestBlockNumber) <= 0) {
                    let rmv = document.getElementById('blockview-list-element-n' + i);
                    rmv.parentNode.removeChild(rmv);
                }
            } else {

                if (nextBottomBlockNum.comparedTo(beforeLatestBlockNumber.add(1)) === 0) {  // Latest block are shown
//                let scrollBottom = blocklist.scrollTop === (blocklistInner.clientHeight - blocklist.clientHeight);

                    addToBlockList('beforeEnd', nextBottomBlockNum);
                    nextBottomBlockNum = nextBottomBlockNum.add(1);

//                if (scrollBottom) { // If scroll was max, set max again
//                    blocklist.scrollTop = blocklistInner.clientHeight - blocklist.clientHeight;
//                }
                }
            }
        }
    };

    blocklist.addEventListener('scroll', scrollEvent);

    scrollCheckIntervalId = setInterval(function () {
        console.log("called");
        scrollEvent();
    }, 1000);   // This is for up scroll glitch more for ie fail-safe

    function scrollEvent() {  // Add scroll event listener
        if (blockListInitialized && !scrollAction) {
//            scrollAction = true;

            if (blocklist.scrollTop <= elementHeight) {
                /* Add more block elements on top of the list */
                let i;

                for (i = 0; i < BLOCK_LIST_ELEMENTS_LOAD_N; i++) {
                    if (nextTopBlockNum.comparedTo(0) < 0) {  // Already showing the oldest block (#0)
                        break;  // Don't add elements anymore
                    }
                    addToBlockList('afterBegin', nextTopBlockNum);   // Add an element on top of the list
                    nextTopBlockNum = nextTopBlockNum.sub(1);
                }

                if (i !== 0) {  // If elements are added
                    blocklist.scrollTop = elementHeight * (i + 1);  // Set scroll position to where it was, for interval execution
                }
            } else if (blocklist.scrollTop >= blocklistInner.clientHeight - blocklist.clientHeight - elementHeight) {
                /* Add more block elements on bottom of the list */
                for (let i = 0; i < BLOCK_LIST_ELEMENTS_LOAD_N; i++) {
                    if (nextBottomBlockNum.comparedTo(latestBlockNumber.add(1)) > 0) {  // Already showing the latest block + 1
                        break;
                    }

                    addToBlockList('beforeEnd', nextBottomBlockNum);    // Add an element on bottom of the list
                    nextBottomBlockNum = nextBottomBlockNum.add(1);
                }
            }

            scrollAction = false;
        }
    }

    function fillBlockList(blockNumber) {
        blocklistInner.innerHTML = '';  // Clear all elements

        /* Fill block list with initial elements around the blockNumber */

        addToBlockList('beforeEnd', blockNumber);  // Add a center block

        elementHeight = blocklistInner.clientHeight; // Get how much y-space is needed for just one element

        nextTopBlockNum = blockNumber.sub(1);      // Next block number listed BEFORE the center block
        nextBottomBlockNum = blockNumber.add(1);   // Next block number listed AFTER the center block

        let topBlocks = Math.ceil(blocklist.clientHeight / elementHeight) + 1;  // Default value of the amount of elements listed before the center block.
        // Total height should be one element's height higher from the same as the list div height, if this number of elements are stacked

        if (topBlocks > MAX_INIT_BLOCK_LIST_ELEMENTS_PER_SIDE) {    // This stops infinite loop to happen if something went wrong
            topBlocks = MAX_INIT_BLOCK_LIST_ELEMENTS_PER_SIDE;
        }

        let bottomBlocks = topBlocks;   // Both default amount of bottom and top blocks are the same

        if (blockNumber.sub(topBlocks).comparedTo(0) < 0) {  // Check if this exceeds the lower limit of zero (minimum block number)
            topBlocks = blockNumber;    // Think blockNumber as the amount of blocks remaining on top of the center block.
            // This would list all elements from zero to before the center block
        }

        if (blockNumber.add(bottomBlocks).comparedTo(latestBlockNumber.add(1)) > 0) {  // Check if this exceeds the upper limit of latest block number + 1
            bottomBlocks = (latestBlockNumber.add(1)).sub(blockNumber).toNumber();
        }

        /* Most fun part! Add elements to the HTML */

        for (let i = 0; i < topBlocks; i++) {
            addToBlockList('afterBegin', nextTopBlockNum);    // Add element before the center block, watch out for decrement
            nextTopBlockNum = nextTopBlockNum.sub(1);
        }

        for (let i = 0; i < bottomBlocks; i++) {   // Add predecessors of the block
            addToBlockList('beforeEnd', nextBottomBlockNum);
            nextBottomBlockNum = nextBottomBlockNum.add(1);
        }

        /* Try to set scroll bar where the center block become center of the list */

        let yscroll = Math.round(elementHeight * (topBlocks + 0.5) - blocklist.clientHeight / 2);
        let yscrollMax = blocklistInner.clientHeight - blocklist.clientHeight;

        yscroll = Math.max(0, Math.min(yscroll, yscrollMax));   // Cannot scroll to negative or outside from an box

        blocklist.scrollTop = yscroll;  // Set scroll bar
    }

    function addToBlockList(position, blockNumber) {
        blocklistInner.insertAdjacentHTML(position, `<span id="blockview-list-element-n${blockNumber}" class="blockview-list-element">${blockNumber}</span>`);
    }

</script>
<footer>
    <div class="pure-g">
        <div class="pure-u-1-1">
            2017 Made with ‚ù§ by Cupmouse <a href="https://twitter.com/Cupnmouse" target="_blank"><i style="color: #1da1f2" class="fa fa-twitter" aria-hidden="true"></i></a><br>
            <!-- Just kidding, who the hell loves code. Is it kind of a weird fetish? -->
        </div>
    </div>
</footer>
</body>
</html>